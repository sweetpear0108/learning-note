# 哨兵机制
## 参考
[Redis 核心技术与实战](https://time.geekbang.org/column/intro/100056701)

[小林coding redis](https://www.xiaolincoding.com/redis/cluster/sentinel.html)

## 原理
### 引入哨兵的目的
主从复制机制可以保证从库断连恢复后数据一致性以及整体服务的可用性，但是如果主库故障就会导致写操作阻塞以及同步终止，这时就需要引入哨兵机制了（Sentinel）。

### 哨兵的三任务
哨兵也是一个独立的redis进程，负责三个任务：**监控、选主、通知**

* 监控：周期性地给所有的主从库发送 PING 命令，检测它们是否仍然在线运行。如果响应超时就会把对应节点标记为“下线状态”，如果主库下线，就需要进入**选主**任务
* 选主：当主库挂了就需要根据*一定的规则*（后边会说）选择一个从库实例作为新主库
* 通知：将新主库连接信息同步给*其他从库*和*客户端*，让主从重新建立起同步连接

### 哨兵集群
单哨兵的问题：
* 单个哨兵故障会导致无法进行主从切换
* 哨兵自身网络延迟导致误判主节点下线

解决：哨兵集群

原理：发布者/订阅者机制

注意事项：所有哨兵的配置应该保持一致

### 哨兵集群配置
哨兵配置文件中：
`sentinel monitor <master-name> <ip> <redis-port> <quorum> `

可见哨兵只需要知道主节点ip端口，那么哨兵之间以及哨兵从节点之间是怎么感知的呢？

### 哨兵之间如何建立连接
依托发布订阅机制。主库中有一个`sentinel:hello”`频道，当一个新哨兵加入后，会向所有订阅该频道的哨兵广播新哨兵的ip端口号，从而建立连接。

### 哨兵从节点之前如何建立连接
哨兵向主库发送`INFO`命令获取所有从库ip端口，从而建立连接。

## 监控
### 主观下线、客观下线
当哨兵发现响应超时后，会判断主库为“主观下线”状态，即“我认为主库下线了”，然后发送命令询问其他哨兵是否赞同这个判断，当赞同票超过配置文件中的`quorum`数量时，就可以标记主库为“客观下线”，
`quorum`值默认是`n/2+1`（n为哨兵数）。

ps：客观下线只针对主库，对于从库判定主观下线就够了

## 选主
在正式开始之前需要确认一点：选主的任务是由哪个哨兵执行的？

### 投票选取leader哨兵
从**候选者**中通过投票选出leader负责接下来的主从故障转移。每个哨兵只有一次投票机会，候选者会把票投给自己。

候选者是刚刚判定主节点**客观**下线的所有哨兵。

成为leader条件：
1. 拿到半数以上赞成票
2. 大于等于哨兵配置文件中的`quorum`值

![leader](https://learn.lianglianglee.com/%e4%b8%93%e6%a0%8f/Redis%20%e6%a0%b8%e5%bf%83%e6%8a%80%e6%9c%af%e4%b8%8e%e5%ae%9e%e6%88%98/assets/5f6ceeb9337e158cc759e23c0f375fd9-20221015223039-rehek98.jpg)

### 选择新的主节点
选择的原则：（筛选+打分）打分阶段遇到最高分从库就选择它
1. 留下当前在线且之前超时次数小于10次的从库
2. 优先级最高的从库得分高，优先级由用户配置
3. 和旧主库同步程度最接近的从库得分高，主库从库在环形缓存数组（repl_backlog_buffer）上都有自己的复制进度offset，判断主从offset的距离
4. ID 号小的从库得分高，ID是实例编号

## 通知
通知从库和客户端
### 通知从库
首先，向选定的节点发送`slaveof no one`命令将其升级为新主节点，然后通过`slaveof ip port`将其他所有从节点连接到新主节点。

此外，还需要监听旧主节点，当他重新上线时需要将其转变成新主节点的从库。

### 通知客户端
主从故障转移的每个事件都对应发布订阅机制中的一个频道，客户端可以订阅对应频道的消息得知主从切换状态。

## 总结
多节点之前怎么协调的：
* 相互感知：发布订阅
* 做决定：投票