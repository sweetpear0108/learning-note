# Postgres æ‰¹é‡åˆ é™¤è¯­å¥è¶…æ—¶
## åœºæ™¯
æ’­æ”¾è®°å½•è¡¨`history`ä¸­å¤§çº¦æœ‰å°†è¿‘10äº¿æ¡æ•°æ®ï¼Œä¸ºäº†å‡å°‘å†…å­˜å ç”¨ï¼Œåå°ä»»åŠ¡ä»¥æ¯ç§’ä¸€æ¬¡çš„é€Ÿåº¦åˆ é™¤è¶…è¿‡1å¹´æœªæ›´æ–°çš„æ—§è®°å½•ã€‚

* è¡¨ç»“æ„ï¼ˆç¤ºæ„ç»“æ„ï¼‰
```sql
        Table "public.history"
 Column |  Type  | Collation | Nullable | Default
--------+--------+-----------+----------+---------
 uid    | text   |           | not null |
 vid    | text   |           | not null |
 ts     | bigint |           | not null |
Indexes:
    "history_pkey" PRIMARY KEY, btree (uid, vid)
    "history_ts" btree (ts)
```

* åˆ é™¤è¯­å¥
`delete from history where (uid, vid) in (select uid, vid from history where ts <= $1 limit 500)`

## é—®é¢˜å‡ºç°
ä»»åŠ¡ç¨³å®šè¿è¡Œäº†ä¸€å¹´å¤šçš„æ—¶é—´ï¼Œçªç„¶æœ‰ä¸€å¤©çº¿ä¸Šæ—¥å¿—å‡ºç°äº†å¤§é‡çš„è¶…æ—¶æŠ¥é”™ï¼Œæ’æŸ¥åå‘ç°æ˜¯pgæ‰§è¡Œåˆ é™¤è¯­å¥çš„æ—¶å€™è¶…è¿‡äº†æœ€å¤§æ—¶é™ `pq: canceling statement due to user request`

## é—®é¢˜æ’æŸ¥
### åˆ†æè¯­å¥æ‰§è¡Œè®¡åˆ’
`EXPLAIN ANALYZE statement`æŸ¥çœ‹è¯¥è¯­å¥çš„æ‰§è¡Œæƒ…å†µï¼Œå‘ç°é•¿æ—¶é—´æ— å“åº”ï¼Œç¼©å°`limit`æ•°é‡é‡è¯•ï¼Œå¾—åˆ°ï¼š

```bash
                                                                                     QUERY PLAN
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Delete on history  (cost=32.45..119.05 rows=83 width=87) (actual time=3791.173..3791.175 rows=0 loops=1)
   ->  Nested Loop  (cost=32.45..119.05 rows=83 width=87) (actual time=3774.474..3789.531 rows=10 loops=1)
         ->  HashAggregate  (cost=31.75..31.85 rows=10 width=138) (actual time=3771.885..3771.904 rows=10 loops=1)
               Group Key: "ANY_subquery".uid, "ANY_subquery".vid
               Batches: 1  Memory Usage: 24kB
               ->  Subquery Scan on "ANY_subquery"  (cost=0.00..31.70 rows=10 width=138) (actual time=103.109..3771.850 rows=10 loops=1)
                     ->  Limit  (cost=0.00..31.60 rows=10 width=57) (actual time=103.104..3771.828 rows=10 loops=1)
                           ->  Seq Scan on history history_1  (cost=0.00..48477444.80 rows=15343146 width=57) (actual time=103.103..3771.821 rows=10 loops=1)
                                 Filter: (ts <= '1678603902000'::bigint)
                                 Rows Removed by Filter: 6974992
         ->  Index Scan using history_pkey on history  (cost=0.70..8.72 rows=1 width=63) (actual time=1.757..1.757 rows=1 loops=10)
               Index Cond: ((uid = "ANY_subquery".uid) AND (vid = "ANY_subquery".vid))
 Planning Time: 0.376 ms
 Execution Time: 3791.369 ms
(14 è¡Œè®°å½•)
```
å‘ç°ä¸»è¦é˜»å¡åœ¨å­æŸ¥è¯¢ï¼Œä¼˜åŒ–å™¨ç«Ÿç„¶é€‰æ‹©äº†`Seq Scan`é¡ºåºæ‰«æï¼Œå¤§é‡ä¸ç¬¦åˆæ¡ä»¶çš„æ•°æ®è¢«`Filter`ç­›æ‰ï¼Œæ—¶é—´å°±è€—åœ¨è¿™ä¸ªä¸Šè¾¹äº†ã€‚

`å•Šï¼Ÿtsä¸Šä¸æ˜¯æœ‰ç´¢å¼•ä¹ˆï¼Œè¿™ä¹ˆå¤§çš„è¡¨ç«Ÿç„¶é€‰æ‹©äº†é¡ºåºæ‰«æï¼Ÿ`

### é—®ä¸€ä¸‹GPT:é¡ºåºå’Œç´¢å¼•æ‰«ææ˜¯å¦‚ä½•å–èˆçš„ï¼Ÿ

åœ¨PostgreSQLä¸­ï¼Œå³ä½¿åœ¨é€‰æ‹©ç›¸å…³åˆ—ä¸Šå­˜åœ¨ç´¢å¼•ï¼ŒæŸ¥è¯¢è®¡åˆ’ä¹Ÿå¯èƒ½é€‰æ‹©é¡ºåºæ‰«æï¼ˆSequential Scanï¼‰è€Œä¸æ˜¯ç´¢å¼•æ‰«æï¼ˆIndex Scanï¼‰ã€‚è¿™æ˜¯å› ä¸ºæŸ¥è¯¢ä¼˜åŒ–å™¨éœ€è¦åŸºäºå¤šç§å› ç´ åšå‡ºå†³ç­–ï¼Œå¦‚é¢„è®¡çš„æŸ¥è¯¢ä»£ä»·ï¼Œè¡¨å¤§å°ï¼Œæ•°æ®çš„åˆ†å¸ƒç­‰ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¯èƒ½çš„åŸå› ï¼š

1. **å…¨è¡¨æ‰«æä¼˜äºç´¢å¼•æ‰«æ**ï¼šå€˜è‹¥ä½ è¦æŸ¥è¯¢çš„æ•°æ®å æ®äº†è¡¨çš„å¤§éƒ¨åˆ†ï¼Œé¡ºåºæ‰«æå¯èƒ½æ›´æœ‰æ•ˆã€‚PostgreSQLæŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šæƒè¡¡å…¨è¡¨æ‰«æå’Œç´¢å¼•æ‰«æçš„ä»£ä»·ï¼Œå¦‚æœå…¨è¡¨æ‰«æçš„é¢„è®¡ä»£ä»·æ›´ä½ï¼Œé‚£ä¹ˆå®ƒå¯èƒ½ä¼šé€‰æ‹©å…¨è¡¨æ‰«æã€‚

2. **ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®**ï¼šPostgreSQLçš„æŸ¥è¯¢ä¼˜åŒ–å™¨åŸºäºç»Ÿè®¡ä¿¡æ¯å¯¹æŸ¥è¯¢è®¡åˆ’è¿›è¡Œä¼˜åŒ–ã€‚å¦‚æœè¡¨çš„ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ï¼ˆä¾‹å¦‚ï¼Œè¡¨æ•°æ®å·²ç»å‘ç”Ÿäº†å¤§å¹…åº¦å˜åŒ–ä½†æ˜¯æ²¡æœ‰é‡æ–°æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ï¼‰ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨å¯èƒ½ä¼šåšå‡ºé”™è¯¯çš„å†³ç­–ï¼Œå³ä½¿ç´¢å¼•æ‰«ææ›´é«˜æ•ˆï¼Œä¹Ÿå¯èƒ½é€‰æ‹©é¡ºåºæ‰«æã€‚

3. **ç´¢å¼•åˆ—çš„é€‰æ‹©æ€§ä¸é«˜**ï¼šå¦‚æœç´¢å¼•åˆ—çš„å€¼é‡å¤åº¦å¾ˆé«˜ï¼ˆä¾‹å¦‚ï¼Œæ€§åˆ«ã€æ˜¯å¦å¯ç”¨ç­‰å€¼åªæœ‰å‡ ç§çš„åˆ—ï¼‰ï¼Œé‚£ä¹ˆä½¿ç”¨ç´¢å¼•æ‰«æçš„æ•ˆç‡å¯èƒ½å¹¶ä¸é«˜ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨å¯èƒ½ä¼šé€‰æ‹©é¡ºåºæ‰«æã€‚

4. **ç³»ç»Ÿå‚æ•°è®¾ç½®çš„é—®é¢˜**ï¼šæŸäº›PostgreSQLç³»ç»Ÿå‚æ•°å¯èƒ½å½±å“åˆ°ç´¢å¼•çš„ä½¿ç”¨ï¼Œæ¯”å¦‚`enable_seqscan`å‚æ•°æ§åˆ¶äº†æ˜¯å¦ä¼˜å…ˆä½¿ç”¨é¡ºåºæ‰«æã€‚

å¦‚æœä½ æ³¨æ„åˆ°äº†æŸ¥è¯¢è®¡åˆ’ä¸­ä¸€ç›´ä½¿ç”¨åºåˆ—æ‰«æè€Œä¸æ˜¯ç´¢å¼•æ‰«æï¼Œä¸”ç´¢å¼•æ‰«ææ˜æ˜¾æ›´é«˜æ•ˆï¼Œä½ å¯èƒ½éœ€è¦é‡æ–°æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ï¼ˆä½¿ç”¨`ANALYZE`å‘½ä»¤ï¼‰ï¼Œæˆ–è€…æ£€æŸ¥ä½ çš„æŸ¥è¯¢æ˜¯å¦èƒ½å¤Ÿæœ‰æ•ˆçš„åˆ©ç”¨ç´¢å¼•ï¼Œæˆ–è€…å®¡æŸ¥å¹¶è°ƒæ•´ç›¸å…³çš„ç³»ç»Ÿå‚æ•°ã€‚

### é€ä¸€æ’æŸ¥
1. å…¨è¡¨æ‰«æä¼˜äºç´¢å¼•æ‰«æï¼Ÿä¸ç¡®å®šã€‚å…¨è¡¨10äº¿æ¡æ•°æ®ï¼Œå…¨è¡¨æ‰«æä¼šæ¯”ç´¢å¼•æ‰«ææ›´é«˜æ•ˆä¹ˆï¼Ÿ

2. ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ï¼Ÿä¸ç¡®å®šã€‚

3. ç´¢å¼•åˆ—çš„é€‰æ‹©æ€§ä¸é«˜ï¼Ÿä¸å¤ªå¯èƒ½ğŸ™…ã€‚tsæ˜¯æŒ‰ç…§è§‚çœ‹æ—¶é—´æ’åºçš„ï¼Œä¸å­˜åœ¨é‡å¤åº¦å¾ˆé«˜çš„æƒ…å†µã€‚

4. ç³»ç»Ÿå‚æ•°è®¾ç½®çš„é—®é¢˜ï¼Ÿä¸å¤ªå¯èƒ½ğŸ™…ã€‚ä»»åŠ¡æ­£å¸¸è¿è¡Œä¸€æ®µæ—¶é—´äº†ã€‚

psï¼š`EXPLAIN`ä¸­costä»£è¡¨æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼°ç®—çš„æŸ¥è¯¢ä»£ä»·ï¼ŒåŸå› ä¸€å…³äºå…¨è¡¨æ‰«æå’Œç´¢å¼•æ‰«æçš„å–èˆå°±å–å†³äºä¼˜åŒ–å™¨å¯¹ä¸¤ç§æ‰«ææ–¹å¼çš„**ä»£ä»·ä¼°ç®—**ï¼Œè€Œä¼°ç®—åˆ™éœ€è¦å‚è€ƒåŸå› äºŒæåˆ°çš„**ç»Ÿè®¡ä¿¡æ¯**ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€äºŒæ˜¯ç›¸å…³çš„ã€‚

### æœ‰ç´¢å¼•ä½†ä¸èµ°çš„æƒ…å†µæœ‰å“ªäº›ï¼Ÿ
1. è¡¨å¾ˆå°ï¼ˆ100è¡Œä»¥å†…ï¼‰ï¼Œé¡ºåºæ‰«æçš„æ•ˆç‡å¯èƒ½ä¼šé«˜äºç´¢å¼•æ‰«æã€‚

2. è¿”å›ç»“æœå æ€»è¡¨å¾ˆå¤§æ¯”ä¾‹ã€‚

3. å½“`LIMIT`æ•°é‡å¾ˆå°æ—¶ï¼Œä¼˜åŒ–å™¨å¯èƒ½ä¼šè®¤ä¸ºâ€œé¡ºåºæ‰«æç›´åˆ°ç»“æœè¾¾åˆ°é™åˆ¶æ•°é‡åç»ˆæ­¢â€ä¼šæ›´å¿«çš„æ‰¾åˆ°ç»“æœï¼›ä½†è¿™æ˜¯**åŒåˆƒå‰‘**ï¼Œä¾èµ–äºè¡¨ç»Ÿè®¡æ•°æ®çš„å‡†ç¡®æ€§ã€‚

### ä¼˜åŒ–å™¨å‚è€ƒçš„ç»Ÿè®¡ä¿¡æ¯æœ‰å“ªäº›ï¼Ÿ

1. **è¡¨çš„å¤§å°**ï¼šä¸€èˆ¬æ¥è¯´ï¼Œå¯¹äºéå¸¸å°çš„è¡¨ï¼Œé¡ºåºæ‰«æå¾€å¾€æ›´æœ‰æ•ˆï¼Œå› ä¸ºç´¢å¼•æ‰«ææ¶‰åŠåˆ°æŸ¥æ‰¾ç´¢å¼•å¹¶è·å–ç£ç›˜ä¸Šæ•°æ®çš„è¿‡ç¨‹ï¼Œè¿™å¯¹äºå°è¡¨æ¥è¯´å¯èƒ½æ¯”ç›´æ¥é¡ºåºæ‰«ææ›´è€—æ—¶ã€‚ç›¸åï¼Œå¯¹äºå¤§è¡¨ï¼Œç´¢å¼•æ‰«æå¾€å¾€èƒ½æ˜¾è‘—æé«˜æ•ˆç‡ã€‚

2. **ç´¢å¼•çš„é€‰æ‹©æ€§**ï¼šç´¢å¼•çš„é€‰æ‹©æ€§æ˜¯æŒ‡é€šè¿‡ç´¢å¼•èƒ½å¤ŸåŒºåˆ†çš„è®°å½•çš„ç™¾åˆ†æ¯”ã€‚å¦‚æœç´¢å¼•çš„é€‰æ‹©æ€§è¾ƒé«˜ï¼ˆä¾‹å¦‚ï¼Œä¸»é”®ç´¢å¼•ï¼‰ï¼Œé‚é‚£ä¹ˆç´¢å¼•æ‰«æå¾€å¾€æ›´æœ‰æ•ˆã€‚

3. **æŸ¥è¯¢çš„é€‰æ‹©åº¦**ï¼šå¦‚æœæŸ¥è¯¢è¿‡æ»¤å¤§éƒ¨åˆ†æ•°æ®ï¼Œé‚£ä¹ˆç´¢å¼•æ‰«æå¯¹äºæ€§èƒ½çš„æå‡æ›´æ˜æ˜¾ã€‚å› ä¸ºé¡ºåºæ‰«æéœ€è¦æ‰«ææ•´ä¸ªè¡¨ï¼Œè€Œç´¢å¼•æ‰«æåªéœ€è¦è®¿é—®æ»¡è¶³æ¡ä»¶çš„ç´¢å¼•é¡¹å’Œç›¸å…³è®°å½•ã€‚

4. **ç¡¬ä»¶æ€§èƒ½**ï¼šç¡¬ä»¶çš„ IO æ€§èƒ½å’Œ CPU æ€§èƒ½ä¹Ÿä¼šå½±å“æ‰«ææ–¹å¼çš„é€‰æ‹©ã€‚IO å¯†é›†çš„å·¥ä½œè´Ÿè½½å¯èƒ½æ›´é€‚åˆä½¿ç”¨ç´¢å¼•æ‰«æï¼Œè€Œ CPU å¯†é›†çš„å·¥ä½œè´Ÿè½½å¯èƒ½æ›´é€‚åˆä½¿ç”¨é¡ºåºæ‰«æã€‚

5. **ç´¢å¼•å’Œè¡¨çš„ç‰©ç†é¡ºåº**ï¼šå¦‚æœè¡¨çš„ç‰©ç†é¡ºåºä¸ç´¢å¼•çš„é¡ºåºé«˜åº¦ç›¸å…³ï¼ˆcorrelation æ¥è¿‘ 1ï¼‰ï¼Œé‚£ä¹ˆä½¿ç”¨ç´¢å¼•æ‰«æçš„æˆæœ¬å¯èƒ½é™ä½ï¼Œå› ä¸ºé¡ºåº IO å¾€å¾€æ¯”éšæœº IO æ›´é«˜æ•ˆã€‚

## é—®é¢˜å®šä½
é€šè¿‡æ’æŸ¥å¯ä»¥çŒœæµ‹ï¼šæ˜¯ä¼˜åŒ–å™¨åœ¨æ‰§è¡ŒæŸ¥è¯¢å‘½ä»¤æ—¶ï¼Œå¯¹ä»£ä»·ä¼°ç®—å‡ºç°äº†é”™è¯¯ï¼Œå¯¼è‡´é€‰æ‹©äº†å®é™…æ€§èƒ½æ›´å·®çš„å…¨è¡¨æ‰«ææ–¹æ³•ã€‚

### æ¨ªå‘å¯¹æ¯”å…¶ä»–è¡¨
é™¤äº†`history`è¡¨ä¹‹å¤–ï¼Œæ•°æ®åº“ä¸­è¿˜æœ‰ä¸¤ä¸ªç»“æ„ç›¸ä¼¼ã€æ•°æ®é‡ç›¸ä¼¼ã€ç´¢å¼•è®¾ç½®ç›¸ä¼¼çš„è®°å½•è¡¨`history_a`,`history_b`ï¼ˆç®€ç§°aè¡¨bè¡¨ï¼‰ï¼Œå…¶ä¸­aè¡¨å’Œhistoryä¸€æ ·åœ¨æ‰§è¡Œåå°åˆ é™¤ä»»åŠ¡ï¼Œbè¡¨æ²¡æœ‰æ‰§è¡Œè¿‡åˆ é™¤ä»»åŠ¡ã€‚

æµ…çœ‹ä¸€çœ¼è¡¨å†…æ€»è¡Œæ•°ï¼š
```bash
x=> SELECT relname, reltuples FROM pg_class r JOIN pg_namespace n ON (relnamespace = n.oid) WHERE relkind = 'r' AND n.nspname = 'public';
       relname     |   reltuples
-------------------+---------------
 history_a         |  7.233728e+08
 history           | 9.3278854e+08
 history_b         |  8.412001e+08
```

å¯¹historyã€aã€båˆ†åˆ«æ‰§è¡ŒæŸ¥è¯¢å‘½ä»¤ï¼š
```bash
x=> explain analyze select uid, vid from history_a where ts <= 1678692987000 limit 100;
                                                                        QUERY PLAN
----------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=0.57..329.24 rows=100 width=57) (actual time=0.074..11.583 rows=100 loops=1)
   ->  Index Scan using history_a_ts_1 on history_a  (cost=0.57..49428562.93 rows=15039219 width=57) (actual time=0.073..11.573 rows=100 loops=1)
         Index Cond: (ts <= '1678692987000'::bigint)
 Planning Time: 1.400 ms
 Execution Time: 11.617 ms
(5 è¡Œè®°å½•)

x=> explain analyze select uid, vid from history where ts <= 1678692987000 limit 100;
                                                               QUERY PLAN
-----------------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=0.00..262.93 rows=100 width=57) (actual time=519.878..14138.338 rows=100 loops=1)
   ->  Seq Scan on history  (cost=0.00..48477444.80 rows=18437250 width=57) (actual time=519.877..14138.275 rows=100 loops=1)
         Filter: (ts <= '1678692987000'::bigint)
         Rows Removed by Filter: 24919480
 Planning Time: 0.671 ms
 Execution Time: 14138.486 ms
(6 è¡Œè®°å½•)

x=> explain analyze select uid, vid from history_b where ts <= 1678692987000 limit 100;
                                                                  QUERY PLAN
-----------------------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=0.00..14.53 rows=100 width=77) (actual time=2.032..12.098 rows=100 loops=1)
   ->  Seq Scan on history_b  (cost=0.00..42239628.56 rows=290642848 width=77) (actual time=2.031..12.085 rows=100 loops=1)
         Filter: (ts <= '1678692987000'::bigint)
         Rows Removed by Filter: 1033
 Planning Time: 0.610 ms
 Execution Time: 15.866 ms
(6 è¡Œè®°å½•)
```

* å¥½å¥‡æ€ªï¼Œå‘ç°aè¡¨é€‰æ‹©äº†ç´¢å¼•æ‰«æï¼Œbå’Œhistoryè¡¨éƒ½æ˜¯é¡ºåºæ‰«æï¼Œä½†æ˜¯bè¡¨æ‰§è¡Œé€Ÿåº¦æ˜¾è‘—å¿«äºhistoryè¡¨ã€‚

### çºµå‘å¯¹æ¯”è‡ªå·±
```bash
x=> explain analyze select uid, vid from history where ts <= 1678763273000 limit 500;
                                                              QUERY PLAN
---------------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=0.00..1166.31 rows=500 width=57) (actual time=10.661..7664.132 rows=500 loops=1)
   ->  Seq Scan on history  (cost=0.00..48421139.20 rows=20758242 width=57) (actual time=10.660..7663.903 rows=500 loops=1)
         Filter: (ts <= '1678763273000'::bigint)
         Rows Removed by Filter: 14947898
 Planning Time: 0.056 ms
 Execution Time: 7666.074 ms
(6 è¡Œè®°å½•)

x=> explain analyze select uid, vid from history where ts <= 1678763273000 order by ts limit 500;
                                                                             QUERY PLAN
--------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=0.57..1595.46 rows=500 width=65) (actual time=1.700..64.891 rows=500 loops=1)
   ->  Index Scan using history_ts_1 on history  (cost=0.57..66214154.35 rows=20758242 width=65) (actual time=1.699..64.824 rows=500 loops=1)
         Index Cond: (ts <= '1678763273000'::bigint)
 Planning Time: 0.053 ms
 Execution Time: 64.949 ms
(5 è¡Œè®°å½•)
```

* æ·»åŠ äº†`order by`å¼ºåˆ¶å‘½ä»¤èµ°ç´¢å¼•ï¼Œå‘ç°èµ°ç´¢å¼•çš„ä¼°ç®—costæ¯”é¡ºåºæ‰«æçš„ä¼°ç®—costè¦ä½ï¼Œè¯´æ˜äº†ä¼˜åŒ–å™¨ä¸ºä»€ä¹ˆä¼šé€‰æ‹©é¡ºåºæ‰«æã€‚åŒæ ·ä¹Ÿè¯´æ˜**ä¼°ç®—å‡ºç°äº†é—®é¢˜**ã€‚

### çŒœæƒ³
1. æ‰¹é‡åˆ é™¤å¯¼è‡´äº†é¡ºåºæ‰«æè€—æ—¶å¢åŠ ï¼Œå¯èƒ½å’Œé¢‘ç¹åˆ é™¤æ’å…¥å¯¼è‡´ç£ç›˜ç‰©ç†é¡ºåºä¹±åºæœ‰å…³ï¼Œå› æ­¤åœ¨éå†æ—¶éœ€è¦è®¿é—®æ›´å¤šçš„å†…å­˜é¡µã€‚
2. ä¼˜åŒ–å™¨åœ¨historyè¡¨ä¸Šå†³ç­–æ‰§è¡Œè®¡åˆ’æ—¶**å‚è€ƒçš„ç»Ÿè®¡æ•°æ®æœ‰é—®é¢˜**ï¼Œå¯¼è‡´ä»£ä»·ä¼°ç®—å‡ºç°åå·®ï¼Œå¯èƒ½çš„åŸå› æ˜¯æ²¡æœ‰åŠæ—¶æ›´æ–°ç»Ÿè®¡æ•°æ®ã€‚

### éªŒè¯
æŸ¥è¯¢historyè¡¨å’Œaè¡¨çš„çŠ¶æ€ä¿¡æ¯è¡¨ï¼ŒæŸ¥çœ‹æœ€åæ‰§è¡Œ`vacuum`å’Œ`analyze`çš„æ—¶é—´ã€‚

```bash
x=> select relname,last_analyze,last_autoanalyze,last_autovacuum from  pg_stat_user_tables where relname='history_a' or relname='history';
-[ RECORD 1 ]----+------------------------------
relname          | history_a
last_analyze     |
last_autoanalyze | 2024-03-13 07:05:50.585392+00
last_autovacuum  | 2024-03-11 13:13:25.05856+00
-[ RECORD 2 ]----+------------------------------
relname          | history
last_analyze     |
last_autoanalyze |
last_autovacuum  | 2024-03-13 16:54:04.673357+00
```

* historyè¡¨ç«Ÿç„¶æ²¡æœ‰é…ç½®`auto analyze`ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ï¼ˆbè¡¨ä¹Ÿæ²¡é…ï¼‰

## é—®é¢˜è§£å†³
### æ‰‹åŠ¨æ‰§è¡Œ ANALYZE
`analyze history`ä¼šä»¥**é‡‡æ ·**çš„æ–¹å¼å¯¹è¡¨ç»Ÿè®¡æ•°æ®è¿›è¡Œä¼°ç®—ï¼Œæ‰€ä»¥é€Ÿåº¦ç›¸å¯¹è¾ƒå¿«ï¼›å¹¶ä¸”åªä¼šé˜»å¡å¦‚ vacuumã€åˆ›å»ºç´¢å¼•ã€reindexã€alter tableç­‰å‘½ä»¤ï¼Œ**ä¸ä¼šå½±å“è¡¨çš„è¯»å†™**ã€‚

### é‡æ–°æ‰§è¡Œå‘½ä»¤
```bash
x=> explain analyze select uid, vid from history where ts <= 1678795619000 limit 500;
                                                                           QUERY PLAN
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=0.57..1978.10 rows=500 width=57) (actual time=11.670..16.685 rows=500 loops=1)
   ->  Index Scan using history_ts_1 on history  (cost=0.57..495456.97 rows=125272 width=57) (actual time=11.669..16.638 rows=500 loops=1)
         Index Cond: (ts <= '1678795619000'::bigint)
 Planning Time: 11.769 ms
 Execution Time: 17.972 ms
(5 è¡Œè®°å½•)
```

**é—®é¢˜è§£å†³ã€‚**

æ­¤å¤–ï¼Œè¿˜å¯ä»¥ä¿®æ”¹limitå€¼è§‚å¯Ÿä¸€ä¸‹æ˜¯ä¸æ˜¯å½“limitå¾ˆå°æ—¶ä¼šé¡ºåºæŸ¥è¯¢ï¼š
```bash
x=> explain analyze select uid, vid from history where ts <= 1710418557000 limit 1;
                                                            QUERY PLAN
----------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=0.00..0.05 rows=1 width=57) (actual time=1.055..1.056 rows=1 loops=1)
   ->  Seq Scan on history  (cost=0.00..48494915.20 rows=924846115 width=57) (actual time=1.054..1.054 rows=1 loops=1)
         Filter: (ts <= '1710418557000'::bigint)
 Planning Time: 6.117 ms
 Execution Time: 1.076 ms
(5 è¡Œè®°å½•)
```

æœç„¶å¦‚æ­¤ã€‚

## ç´¢å¼•ä¼˜åŒ–
åœ¨å¯»æ‰¾é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°ç´¢å¼•å†…å­˜å ç”¨è¾ƒå¤§ï¼Œå¯èƒ½ä¸æ•°æ®é¢‘ç¹çš„åˆ é™¤æ–°å¢æœ‰å…³ï¼Œç§°ä¹‹ä¸º**ç´¢å¼•è†¨èƒ€**

æŸ¥è¯¢æ•°æ®åº“ä¸­æ‰€æœ‰è¡¨çš„å¤§å°ï¼š
```sql
SELECT table_name,
       pg_size_pretty(table_size)   AS table_size,
       pg_size_pretty(indexes_size) AS indexes_size,
       pg_size_pretty(total_size)   AS total_size
FROM (
         SELECT table_name,
                pg_table_size(table_name)          AS table_size,
                pg_indexes_size(table_name)        AS indexes_size,
                pg_total_relation_size(table_name) AS total_size
         FROM (
                  SELECT ('"' || table_schema || '"."' || table_name || '"') AS table_name
                  FROM information_schema.tables
                  where table_schema = 'public'  
              ) AS all_tables
         ORDER BY total_size DESC
     ) AS pretty_sizes;
```

reindex:
```sql
REINDEX TABLE CONCURRENTLY history;
```

æˆ–è€…æ‰‹åŠ¨

```sql
CREATE INDEX CONCURRENTLY history_ts_1 ON history(ts);
DROP INDEX CONCURRENTLY history_ts;

CREATE UNIQUE INDEX CONCURRENTLY history_pkey_new ON history(uid, vid);
ALTER TABLE history DROP CONSTRAINT history_pkey, ADD CONSTRAINT history_pkey PRIMARY KEY USING INDEX history_pkey_new;
```